<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title data-i18n="portalTitle">Seva Bharat Portal | Government Schemes for All Indians</title>
	<!-- BOOTSTRAP 5 -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
	<!-- GOOGLE FONTS: Added Noto Sans Devanagari (Hindi/Marathi) and Noto Sans Telugu -->
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@700;800&family=Noto+Sans+Devanagari:wght@400;700&family=Noto+Sans+Telugu:wght@400;700&display=swap"
		rel="stylesheet" />
	<!-- FONT AWESOME -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" />
	<!-- LEAFLET CSS -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

	<style>
		:root {
			--color-primary: #0a2540;
			--color-secondary: #f0f4f9;
			--color-accent-saffron: #FF9933;
			--color-accent-green: #138808;
			--color-text-light: #f8f9fa;
			--color-text-dark: #343a40;
			--color-white: #FFFFFF;
			--border-radius: 0.75rem;
			--shadow-sm: 0 4px 6px rgba(0, 0, 0, 0.05);
			--shadow-md: 0 8px 15px rgba(0, 0, 0, 0.1);
			/* --- Category Colors --- */
			--cat-housing: #5a67d8;
			/* Indigo */
			--cat-health: #d53f8c;
			/* Pink */
			--cat-agriculture: #38a169;
			/* Green */
			--cat-business: #dd6b20;
			/* Orange */
			--cat-utility: #00b5d8;
			/* Cyan */
			--cat-finance: #d69e2e;
			/* Gold */
			--cat-education: #805ad5;
			/* Purple */
			--cat-social: #3182ce;
			/* Blue */
		}

		/* --- Animation Keyframes --- */
		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(20px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		@keyframes animated-gradient {
			0% {
				background-position: 0% 50%;
			}

			50% {
				background-position: 100% 50%;
			}

			100% {
				background-position: 0% 50%;
			}
		}

		@keyframes floating-background {
			0% {
				background-position: 0% 50%;
			}

			50% {
				background-position: 100% 50%;
			}

			100% {
				background-position: 0% 50%;
			}
		}

		.navbar {
			padding: 0.5rem 0;
		}

		.navbar-brand {
			font-size: 1.6rem;
		}

		body {
			/* FIX: Prioritize Indian language fonts (Devanagari, Telugu) over Latin fonts (Inter) */
			font-family: 'Noto Sans Devanagari', 'Noto Sans Telugu', 'Inter', sans-serif;
			color: var(--color-text-dark);
			/* Using a soft tri-color background inspired by the national flag */
			background: linear-gradient(-45deg, #ffdeb3, var(--color-white), #c8e6c9);
			background-size: 400% 400%;
			animation: floating-background 15s ease-infinite;
			padding-top: 80px;
			/* Space for fixed navbar */
		}

		/* FIX: Ensure all form elements also use the multilingual font stack */
		input, select, textarea, button {
			font-family: 'Noto Sans Devanagari', 'Noto Sans Telugu', 'Inter', sans-serif !important;
		}


		h1,
		h2,
		h3,
		h4,
		h5,
		h6 {
			/* FIX: Apply Devanagari and Telugu font to headings as well */
			font-family: 'Noto Sans Devanagari', 'Noto Sans Telugu', 'Montserrat', sans-serif;
			font-weight: 700;
			color: var(--color-primary);
		}

		.content-panel h2 {
			color: var(--color-primary);
			background: linear-gradient(90deg,
					var(--color-accent-saffron),
					var(--color-accent-green),
					var(--color-accent-saffron));
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-size: 200% auto;
			animation: animated-gradient 4s ease-in-out infinite;
		}

		.title-gradient {
			background: linear-gradient(90deg,
					var(--color-accent-saffron),
					var(--color-accent-green),
					var(--color-accent-saffron));
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-size: 200% auto;
			animation: animated-gradient 4s ease-in-out infinite;
		}
		
		/* Typewriter Specific Styling */
		.typewriter-text {
			font-family: 'Noto Sans Devanagari', 'Noto Sans Telugu', 'Inter', sans-serif; /* FIX: Apply Noto Sans Devanagari here too */
			font-size: 1.25rem;
			color: #6c757d;
			/* text-muted color */
			display: inline-block;
			min-height: 1.25em;
			/* Prevent layout shift */
			/* Add a simple blinking cursor effect using CSS */
			border-right: 2px solid rgba(0, 0, 0, 0.75);
			animation: blink-caret 0.75s step-end infinite;
			opacity: 0;
			/* Hide initially, fadeIn handled by JS after animation starts */
		}

		@keyframes blink-caret {
			from, to { border-color: transparent }
			50% { border-color: rgba(0, 0, 0, 0.75); }
		}

		header.text-center>p {
			/* Removing static fadeIn on the p tag, JS will control opacity of typewriter */
			opacity: 1; 
		}

		.content-panel {
			background: var(--color-white);
			padding: 2.5rem;
			border-radius: var(--border-radius);
			box-shadow: var(--shadow-sm);
			margin-bottom: 2rem;
			animation: fadeIn 0.6s ease-out forwards;
		}

		/* --- Dashboard Nav Links --- */
		#dashboard-links .nav-link {
			font-weight: 500;
			color: var(--color-primary);
			transition: all 0.2s ease-in-out;
			font-size: 0.9rem;
			padding: 0.5rem 1rem;
			position: relative;
			background-color: transparent;
			border-radius: 50px;
			cursor: pointer;
		}

		#dashboard-links .nav-link:hover,
		#dashboard-links .nav-link.active {
			color: var(--color-accent-green);
			background-color: var(--color-secondary);
		}

		#dashboard-links .nav-link.active {
			font-weight: 600;
		}

		.logged-in-status {
			font-size: 0.9rem;
			font-weight: 500;
			color: #065f46;
			/* Dark green */
			background-color: #d1fae5;
			/* Light green */
			padding: 0.5rem 1rem;
			border-radius: 50px;
		}

		.btn-logout {
			background-color: transparent;
			color: #dc3545;
			border: 1px solid transparent;
			border-radius: 50%;
			width: 40px;
			height: 40px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1rem;
			transition: all 0.3s ease;
		}

		.btn-logout:hover {
			background-color: #fee2e2;
			border-color: #dc3545;
		}

		/* --- Professional Scheme Card Styling --- */
		.scheme-card {
			background: linear-gradient(135deg,
					rgba(255, 255, 255, 0.6),
					rgba(255, 255, 255, 0.3));
			-webkit-backdrop-filter: blur(10px);
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255, 255, 255, 0.2);
			border-radius: var(--border-radius);
			box-shadow: var(--shadow-sm);
			transition: all 0.3s ease;
			height: 100%;
			display: flex;
			flex-direction: column;
			overflow: hidden;
			position: relative;
			text-align: left;
		}

		.scheme-card:hover {
			transform: translateY(-8px);
			box-shadow: 0 12px 25px rgba(10, 37, 64, 0.15);
		}

		.scheme-card-header {
			padding: 1rem 3.5rem 1rem 1.5rem;
			display: flex;
			align-items: center;
			border-bottom: 1px solid rgba(255, 255, 255, 0.3);
		}

		.scheme-card-icon-wrapper {
			width: 50px;
			height: 50px;
			flex-shrink: 0;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.5rem;
			margin-right: 1rem;
			color: var(--color-white);
		}

		.scheme-card .card-title {
			font-size: 1.1rem;
			font-weight: 700;
			color: var(--color-primary);
			margin-bottom: 0;
		}

		/* Applying category colors */
		.scheme-card[data-category='Housing'] .scheme-card-icon-wrapper {
			background-color: var(--cat-housing);
		}

		.scheme-card[data-category='Health'] .scheme-card-icon-wrapper {
			background-color: var(--cat-health);
		}

		.scheme-card[data-category='Agriculture'] .scheme-card-icon-wrapper {
			background-color: var(--cat-agriculture);
		}

		.scheme-card[data-category='Business'] .scheme-card-icon-wrapper {
			background-color: var(--cat-business);
		}

		.scheme-card[data-category='Education'] .scheme-card-icon-wrapper {
			background-color: var(--cat-education);
		}

		.scheme-card[data-category='Social'] .scheme-card-icon-wrapper {
			background-color: var(--cat-social);
		}

		.scheme-card .card-body {
			padding: 1.5rem;
			flex-grow: 1;
			display: flex;
			flex-direction: column;
		}

		.card-buttons {
			display: flex;
			justify-content: flex-start;
			gap: 0.5rem;
			margin-top: auto;
			width: 100%;
		}

		.card-buttons .btn {
			flex-grow: 1;
			max-width: 140px;
			font-weight: 600;
			border: none;
			border-radius: 50px;
			transition: all 0.3s ease;
			padding: 0.5rem 0.5rem;
			font-size: 0.875rem;
		}

		.btn-learn-more {
			background-color: var(--color-secondary);
			color: var(--color-primary);
		}

		.btn-apply-now {
			background-color: var(--color-primary);
			color: var(--color-white);
		}

		.btn-save-scheme {
			position: absolute;
			top: 0.75rem;
			right: 0.75rem;
			width: 36px;
			height: 36px;
			display: flex;
			align-items: center;
			justify-content: center;
			background-color: rgba(255, 255, 255, 0.4);
			border-radius: 50%;
			font-size: 1rem;
			color: var(--color-primary);
			cursor: pointer;
			transition: all 0.2s ease;
			-webkit-backdrop-filter: blur(2px);
			backdrop-filter: blur(2px);
		}

		.btn-save-scheme:hover {
			transform: scale(1.1);
			background-color: rgba(255, 255, 255, 0.7);
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}

		.btn-save-scheme.saved {
			color: var(--color-white);
			background-color: var(--color-accent-saffron);
		}

		/* --- Glassmorphism Panels --- */
		#eligibility-checker.content-panel,
		#all-schemes.content-panel,
		#map-section.content-panel,
		#profile-section.content-panel {
			background: rgba(255, 255, 255, 0.45);
			-webkit-backdrop-filter: blur(15px);
			backdrop-filter: blur(15px);
			border: 1px solid rgba(255, 255, 255, 0.2);
		}

		/* --- LOGIN MODAL STYLING --- */
		#loginModal .modal-content {
			background-color: #fdfaf6;
			border-radius: var(--border-radius);
			border: none;
			padding: 1rem;
			position: relative;
			/* Set positioning context for the close button */
		}

		/* APPLYING ABSOLUTE POSITIONING TO CLOSE BUTTONS IN BOTH MODALS FOR CONSISTENCY */
		#loginModal .btn-close,
		#registerModal .btn-close {
			position: absolute;
			top: 1.5rem;
			right: 1.5rem;
			z-index: 2;
			margin: 0;
			/* Override Bootstrap's default margin */
		}

		#loginModal .modal-header,
		#registerModal .modal-header {
			border-bottom: none;
			text-align: center;
			display: block;
			padding-top: 1.5rem;
		}

		.login-title {
			font-size: 2.5rem;
			font-weight: 800;
			background: linear-gradient(90deg, #d88621, #138808);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
		}

		.login-subtitle {
			color: #6c757d;
			font-weight: 500;
		}

		.btn-gradient-login {
			background: linear-gradient(90deg,
					var(--color-accent-saffron),
					var(--color-accent-green));
			border: none;
			color: white;
			font-weight: 700;
			border-radius: 0.75rem;
			padding: 0.75rem;
			transition: all 0.3s ease;
		}

		/* --- Professional Redirect Modal --- */
		#redirectModal .modal-content {
			border-radius: var(--border-radius);
			box-shadow: var(--shadow-md);
			background: linear-gradient(135deg,
					rgba(255, 255, 255, 0.6),
					rgba(255, 255, 255, 0.3));
			-webkit-backdrop-filter: blur(10px);
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255, 255, 255, 0.2);
		}

		.redirect-icon-wrapper {
			width: 60px;
			height: 60px;
			margin: 0 auto;
			background-color: var(--color-secondary);
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.75rem;
			color: var(--color-primary);
		}

		#redirectModal .modal-body h4 {
			font-family: 'Montserrat', sans-serif;
			color: var(--color-primary);
			font-weight: 700;
		}

		#redirectModal .modal-body .btn {
			font-weight: 600;
			border-radius: 50px;
			padding: 0.6rem 1.5rem;
			border: none;
			transition: transform 0.2s ease;
		}

		#redirectModal .modal-body .btn:hover {
			transform: translateY(-2px);
		}

		#redirectModal .btn-secondary {
			background-color: var(--color-secondary);
			color: var(--color-primary);
		}

		#redirectModal .btn-primary {
			background-color: var(--color-primary);
			color: var(--color-white);
		}

		.password-toggle-icon {
			position: absolute;
			top: 50%;
			right: 1rem;
			transform: translateY(-50%);
			cursor: pointer;
			color: #6c757d;
		}

		/* --- Main Gradient Button --- */
		.btn-gradient-main {
			background: linear-gradient(90deg,
					var(--color-accent-saffron),
					var(--color-accent-green));
			color: var(--color-white);
			border: none;
			font-weight: 600;
			transition: all 0.3s ease;
		}

		.btn-gradient-main:hover {
			box-shadow: var(--shadow-sm);
			transform: translateY(-2px);
			opacity: 0.9;
			color: var(--color-white);
		}
		
		/* Loading spinner for AI results */
		.ai-loading-spinner {
			display: inline-block;
			width: 20px;
			height: 20px;
			border: 3px solid #f3f3f3;
			border-top: 3px solid var(--color-accent-green);
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}

		/* --- Profile Section Enhancements --- */
		.profile-avatar {
			width: 80px;
			height: 80px;
			background-color: var(--color-primary);
			color: var(--color-white);
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 2.5rem;
		}

		.saved-scheme-card {
			display: flex;
			align-items: center;
			background-color: var(--color-white);
			padding: 1rem;
			border-radius: var(--border-radius);
			box-shadow: var(--shadow-sm);
			transition: all 0.2s ease-in-out;
			border: 1px solid var(--color-secondary);
			margin-bottom: 1rem;
		}

		.saved-scheme-card:hover {
			transform: translateY(-4px);
			box-shadow: var(--shadow-md);
		}

		.saved-scheme-card .scheme-card-icon-wrapper {
			margin-right: 1.5rem;
			flex-shrink: 0;
		}

		.saved-scheme-card-body {
			flex-grow: 1;
		}

		.saved-scheme-card-body .card-title {
			margin-bottom: 0.25rem;
			font-weight: 600;
		}

		.saved-scheme-card-actions {
			display: flex;
			gap: 0.5rem;
			margin-left: 1rem;
		}
		
		/* Markdown Rendering Fixes for AI Output */
		#ai-result-container h3, #ai-result-container h4, #ai-result-container h5 {
			margin-top: 1.5rem;
			margin-bottom: 0.5rem;
			color: var(--color-primary);
		}
		
		#ai-result-container ul {
			padding-left: 20px;
		}

		/* --- Responsive Design for Mobile --- */
		@media (max-width: 767.98px) {
			body {
				padding-top: 70px;
			}

			.display-4 {
				font-size: 2rem;
			}

			.content-panel {
				padding: 1.5rem;
			}

			.schemes-header {
				flex-direction: column;
				align-items: stretch !important;
			}
		}
	</style>
</head>

<body>

	<!-- ===== NAVIGATION BAR ===== -->
	<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
		<div class="container">
			<a class="navbar-brand title-gradient mb-0" href="#" id="home-link" style="cursor:pointer;" data-i18n="portalTitle">Seva Bharat
				Portal</a>
			
			<!-- LANGUAGE SELECTOR ADDED HERE -->
			<div class="d-flex align-items-center me-3">
				<i class="fa-solid fa-language me-2 text-primary"></i>
				<select class="form-select form-select-sm" id="language-selector" style="width: auto;">
					<option value="en">English</option>
					<option value="hi">हिन्दी (Hindi)</option>
					<option value="mr">मराठी (Marathi)</option>
					<option value="te">తెలుగు (Telugu)</option>
				</select>
			</div>
			<!-- END LANGUAGE SELECTOR -->

			<div id="nav-user-section" class="ms-auto d-flex align-items-center">
				<!-- This content is dynamically generated by JavaScript -->
			</div>
		</div>
	</nav>

	<div class="container my-5">

		<!-- ===== MAIN CONTENT WRAPPER (for toggling view) ===== -->
		<main id="main-content">
			<!-- ===== HEADER ===== -->
			<header class="text-center mb-5">
				<h1 class="display-4 title-gradient" data-i18n="welcomeTitle">Welcome to the Citizen Portal</h1>
				<!-- Changed static paragraph to a span for the typewriter effect -->
				<span class="typewriter-text" id="typewriter-output"></span>
			</header>

			<!-- ===== ELIGIBILITY CHECKER (Added Gender) ===== -->
			<section id="eligibility-checker" class="content-panel">
				<h2 class="text-center mb-4" data-i18n="eligibilityTitle">Quick Eligibility Check</h2>
				<div class="row g-3">
					<div class="col-md-6 col-lg-3">
						<label class="form-label" for="name" data-i18n="yourName">Your Name</label>
						<input type="text" class="form-control" id="name" data-i18n-placeholder="namePlaceholder" placeholder="e.g., Ramesh Kumar" required />
					</div>
					<div class="col-md-6 col-lg-3">
						<label class="form-label" for="state" data-i18n="state">State</label>
						<input type="text" class="form-control" id="state" data-i18n-placeholder="statePlaceholder" placeholder="e.g., Maharashtra" required />
					</div>
					<div class="col-md-6 col-lg-2">
						<label class="form-label" for="age" data-i18n="yourAge">Your Age</label>
						<input type="number" class="form-control" id="age" data-i18n-placeholder="agePlaceholder" placeholder="e.g., 35" required />
					</div>
					<div class="col-md-6 col-lg-2">
						<label class="form-label" for="gender" data-i18n="gender">Gender</label>
						<select class="form-select" id="gender" required>
							<option value="" data-i18n="genderSelect">Select...</option>
							<option value="male" data-i18n="genderMale">Male</option>
							<option value="female" data-i18n="genderFemale">Female</option>
							<option value="other" data-i18n="genderOther">Other</option>
						</select>
					</div>
					<div class="col-md-12 col-lg-2">
						<label class="form-label" for="income" data-i18n="income">Annual Income (₹)</label>
						<input type="number" class="form-control" id="income" data-i18n-placeholder="incomePlaceholder" placeholder="e.g., 250000" required />
					</div>
				</div>
				<div class="text-center mt-4">
					<button id="check-eligibility-btn" class="btn btn-gradient-main btn-lg" data-i18n="findSchemes">Find My Schemes</button>
				</div>
			</section>

			<!-- ===== ALL SCHEMES ===== -->
			<section id="all-schemes" class="content-panel">
				<h2 id="schemes-list-title" class="text-center mb-4" data-i18n="allSchemesTitle">All Government Schemes</h2>
				<button id="reset-filter-btn" class="btn btn-sm btn-outline-danger mb-3 d-none" data-i18n="resetFilter">Clear Eligibility Filter & Show
					All</button>
				<div class="row g-4" id="schemes-grid">
					<!-- Scheme cards will be dynamically loaded here -->
				</div>
			</section>

			<!-- ===== MAP SECTION ===== -->
			<section id="map-section" class="content-panel">
				<h2 class="text-center mb-4" data-i18n="mapTitle">Find a Government Service Center Near You</h2>
				<!-- New Button and Results Container -->
				<div class="text-center mb-4">
					<button id="find-centers-btn" class="btn btn-gradient-main btn-lg" data-i18n="findCenters"><i
							class="fa-solid fa-location-crosshairs me-2"></i>Find Centers Near Me</button>
				</div>
				<div id="center-results" class="mb-4">
					<!-- Results will be displayed here -->
				</div>
				<div id="map" style="height: 450px; border-radius: var(--border-radius); z-index: 0;"></div>
			</section>
		</main>

		<!-- ===== PROFILE SECTION (Initially Hidden) ===== -->
		<section id="profile-section" class="content-panel d-none">
			<div class="d-flex justify-content-between align-items-center mb-4">
				<h2 id="profile-title" class="mb-0" data-i18n="profileTitle">My Dashboard</h2>
				<button class="btn btn-outline-primary" id="back-to-schemes-btn" data-i18n="backToPortal"><i
						class="fa-solid fa-arrow-left me-2"></i>Back
					to Portal</button>
			</div>

			<!-- Professional Profile Card -->
			<div class="card mb-5 border-0" style="background-color: var(--color-secondary);">
				<div class="card-body p-4">
					<div class="row align-items-center">
						<div class="col-auto">
							<div class="profile-avatar">
								<i class="fa-solid fa-user-shield"></i>
							</div>
						</div>
						<div class="col">
							<h4 class="mb-0" id="profile-username-display" data-i18n="profileCardTitle">Citizen Name</h4>
							<p class="text-muted mb-1" id="profile-state-display">Maharashtra</p>
							<small class="text-muted" data-i18n-prefix="profileJoined">Joined: <span id="profile-join-date"></span></small>
						</div>
					</div>
				</div>
			</div>

			<!-- Data Visualization Card -->
			<div class="card mb-5 border-0" style="background-color: var(--color-secondary);">
				<div class="card-body p-4">
					<h4 class="mb-3 text-center" data-i18n="profileChartTitle">Your Saved Schemes Breakdown</h4>
					<div style="max-width: 400px; margin: auto; position: relative;">
						<canvas id="savedSchemesChart"></canvas>
						<div id="chart-placeholder" class="text-center text-muted"
							style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;">
							<p class="mb-0"><i class="fa-solid fa-chart-pie fa-2x mb-2"></i></p>
							<p data-i18n="saveChartPlaceholder">Save schemes to see your personal dashboard.</p>
						</div>
					</div>
				</div>
			</div>

			<h3 class="mt-4 mb-4" data-i18n="profileSavedSchemes">My Saved Schemes</h3>
			<div id="saved-schemes-grid">
				<!-- Saved scheme cards will be dynamically loaded here -->
			</div>
		</section>
	</div>

	<!-- ===== SCHEME DETAIL MODAL ===== -->
	<div class="modal fade" id="schemeDetailModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="schemeDetailModalLabel">Scheme Details</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body" id="scheme-modal-body"></div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<!-- ===== NEW LOGIN MODAL ===== -->
	<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					<div>
						<h2 class="login-title" data-i18n="loginTitle">Seva Sarthi</h2>
						<p class="login-subtitle" data-i18n="loginSubtitle">Your Guide to Government Schemes</p>
					</div>
				</div>
				<div class="modal-body px-4 pb-4">
					<form id="loginForm">
						<div class="mb-3">
							<label for="login-username" class="form-label" data-i18n="loginUsername">Username / Aadhaar Number</label>
							<input type="text" class="form-control" id="login-username" required />
						</div>
						<div class="mb-3">
							<label for="login-password" class="form-label" data-i18n="loginPassword">Password</label>
							<div class="position-relative">
								<input type="password" class="form-control" id="login-password" required />
								<i class="fa-solid fa-eye password-toggle-icon" id="togglePassword"></i>
							</div>
						</div>
						<button type="submit" class="btn btn-gradient-login w-100" data-i18n="loginBtn">Login</button>
					</form>
					<div id="login-feedback" classx="mt-2"></div>
				</div>
			</div>
		</div>
	</div>

	<!-- ===== REGISTRATION MODAL (Close button repositioned and title styled) ===== -->
	<div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					<!-- Wrapped title in a div with login-title class for consistent styling and centering -->
					<div>
						<h2 class="login-title" id="registerModalLabel" data-i18n="registerModalTitle">Register for Seva Bharat</h2>
					</div>
				</div>
				<div class="modal-body px-4 pb-4">
					<form id="registerForm">
						<div class="mb-3">
							<label for="register-name" class="form-label" data-i18n="registerName">Full Name</label>
							<input type="text" class="form-control" id="register-name" required />
						</div>

						<div class="mb-3">
							<label for="register-email" class="form-label" data-i18n="registerEmail">Email Address</label>
							<input type="email" class="form-control" id="register-email" required />
						</div>

						<!-- MODIFICATION: Changed Aadhaar Number back to Username -->
						<div class="mb-3">
							<label for="register-username" class="form-label" data-i18n="loginUsername">Username / Aadhaar Number</label>
							<input type="text" class="form-control" id="register-username" required />
						</div>

						<div class="mb-3">
							<label for="register-password" class="form-label" data-i18n="loginPassword">Password</label>
							<input type="password" class="form-control" id="register-password" required />
						</div>

						<div class="mb-3">
							<label for="register-confirm-password" class="form-label" data-i18n="registerConfirmPassword">Confirm Password</label>
							<input type="password" class="form-control" id="register-confirm-password" required />
						</div>

						<button type="submit" class="btn btn-gradient-main w-100 mt-2" data-i18n="registerBtn">Register</button>
					</form>
					<div id="register-feedback" classx="mt-2"></div>
				</div>
			</div>
		</div>
	</div>

	<!-- ===== REDIRECT CONFIRMATION MODAL ===== -->
	<div class="modal fade" id="redirectModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-body text-center p-4">
					<div class="redirect-icon-wrapper mb-3">
						<i class="fa-solid fa-arrow-up-right-from-square"></i>
					</div>
					<h4 class="modal-title mb-2" data-i18n="redirectTitle">You're Leaving Seva Bharat</h4>
					<p class="text-muted" data-i18n="redirectMessage">You will be redirected to an official government website to complete your application.
						Please have your documents ready.</p>
					<div class="d-flex justify-content-center gap-2 mt-4">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="redirectStay">Stay Here</button>
						<button type="button" class="btn btn-primary" id="confirm-redirect-btn" data-i18n="redirectProceed">Proceed</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- SCRIPTS -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

	<script>
		// Global variables for map and user location
		let mapInstance = null;
		let userLat = 19.2423; // Default Kalyan coordinates
		let userLon = 73.1313;
		const earthRadiusKm = 6371; // Earth's radius in Kilometers (for distance calculation)
		let currentLanguage = 'en';

		// === GLOBAL STATE VARIABLES (Moved outside DOMContentLoaded to fix ReferenceError: isLoggedIn) ===
		let isLoggedIn = false;
		let loggedInUsername = 'Citizen';
		let pendingApplyUrl = null;
		let currentFilteredSchemes = [];
		let allSchemesVisible = false;
		let savedSchemes = [];
		let savedSchemesChartInstance = null;
		let schemesData = []; // Declared globally to store the scheme data
		// ===============================================================================================

		// --- TRANSLATION DATA ---
		const translations = {
			en: {
				portalTitle: "Seva Bharat Portal",
				welcomeTitle: "Welcome to the Citizen Portal",
				typewriterText: "A single, unified platform for government welfare schemes.",
				eligibilityTitle: "Quick Eligibility Check",
				yourName: "Your Name",
				namePlaceholder: "e.g., Ramesh Kumar",
				state: "State",
				statePlaceholder: "e.g., Maharashtra",
				yourAge: "Your Age",
				agePlaceholder: "e.g., 35",
				gender: "Gender",
				genderSelect: "Select...",
				genderMale: "Male",
				genderFemale: "Female",
				genderOther: "Other",
				income: "Annual Income (₹)",
				incomePlaceholder: "e.g., 250000",
				findSchemes: "Find My Schemes",
				allSchemesTitle: "All Government Schemes",
				resetFilter: "Clear Eligibility Filter & Show All",
				mapTitle: "Find a Government Service Center Near You",
				findCenters: "Find Centers Near Me",
				profileTitle: "My Dashboard",
				backToPortal: "Back to Portal",
				profileCardTitle: "Citizen Name",
				profileJoined: "Joined: ",
				profileChartTitle: "Your Saved Schemes Breakdown",
				profileSavedSchemes: "My Saved Schemes",
				saveSchemeTitle: "Save Scheme",
				knowMore: "Know More",
				applyNow: "Apply Now",
				saveSchemePlaceholder: "You haven't saved any schemes yet. Click the bookmark icon on a scheme to save it.",
				saveChartPlaceholder: "Save schemes to see your personal dashboard.",
				loginTitle: "Seva Sarthi",
				loginSubtitle: "Your Guide to Government Schemes",
				loginUsername: "Username / Aadhaar Number",
				loginPassword: "Password",
				loginBtn: "Login",
				registerBtn: "Register",
				registerModalTitle: "Register for Seva Bharat",
				registerName: "Full Name",
				registerEmail: "Email Address",
				registerConfirmPassword: "Confirm Password",
				redirectTitle: "You're Leaving Seva Bharat",
				redirectMessage: "You will be redirected to an official government website to complete your application. Please have your documents ready.",
				redirectStay: "Stay Here",
				redirectProceed: "Proceed",
				aiAssistantTitle: "Gemini AI Scheme Assistant",
				generateGuideBtn: "✨ Generate Simplified Guide & Checklist",
			},
			hi: {
				portalTitle: "सेवा भारत पोर्टल",
				welcomeTitle: "नागरिक पोर्टल में आपका स्वागत है",
				typewriterText: "सरकारी कल्याणकारी योजनाओं के लिए एक एकल, एकीकृत मंच।",
				eligibilityTitle: "त्वरित पात्रता जाँच",
				yourName: "आपका नाम",
				namePlaceholder: "उदा. रमेश कुमार",
				state: "राज्य",
				statePlaceholder: "उदा. महाराष्ट्र",
				yourAge: "आपकी आयु",
				agePlaceholder: "उदा. 35",
				gender: "लिंग",
				genderSelect: "चुनें...",
				genderMale: "पुरुष",
				genderFemale: "महिला",
				genderOther: "अन्य",
				income: "वार्षिक आय (₹)",
				incomePlaceholder: "उदा. 250000",
				findSchemes: "मेरी योजनाएँ खोजें",
				allSchemesTitle: "सभी सरकारी योजनाएँ",
				resetFilter: "पात्रता फ़िल्टर साफ़ करें और सभी दिखाएँ",
				mapTitle: "अपने पास एक सरकारी सेवा केंद्र खोजें",
				findCenters: "मेरे पास केंद्र खोजें",
				profileTitle: "मेरा डैशबोर्ड",
				backToPortal: "पोर्टल पर वापस जाएँ",
				profileCardTitle: "नागरिक का नाम",
				profileJoined: "शामिल: ",
				profileChartTitle: "आपकी सहेजी गई योजनाओं का विवरण",
				profileSavedSchemes: "मेरी सहेजी गई योजनाएँ",
				saveSchemeTitle: "योजना सहेजें",
				knowMore: "और जानें",
				applyNow: "अभी आवेदन करें",
				saveSchemePlaceholder: "आपने अभी तक कोई योजना नहीं सहेजी है। इसे सहेजने के लिए योजना पर बुकमार्क आइकन पर क्लिक करें।",
				saveChartPlaceholder: "अपना व्यक्तिगत डैशबोर्ड देखने के लिए योजनाएँ सहेजें।",
				loginTitle: "सेवा सारथी",
				loginSubtitle: "सरकारी योजनाओं के लिए आपका मार्गदर्शक",
				loginUsername: "उपयोगकर्ता नाम / आधार संख्या",
				loginPassword: "पासवर्ड",
				loginBtn: "लॉग इन करें",
				registerBtn: "रजिस्टर करें",
				registerModalTitle: "सेवा भारत के लिए पंजीकरण करें",
				registerName: "पूरा नाम",
				registerEmail: "ईमेल पता",
				registerConfirmPassword: "पासवर्ड की पुष्टि करें",
				redirectTitle: "आप सेवा भारत छोड़ रहे हैं",
				redirectMessage: "आप अपना आवेदन पूरा करने के लिए एक आधिकारिक सरकारी वेबसाइट पर पुनर्निर्देशित होंगे। कृपया अपने दस्तावेज़ तैयार रखें।",
				redirectStay: "यहीं रुकें",
				redirectProceed: "आगे बढ़ें",
				aiAssistantTitle: "जेमिनी एआई योजना सहायक",
				generateGuideBtn: "✨ सरलीकृत मार्गदर्शिका और चेकलिस्ट जनरेट करें",
			},
			mr: {
				portalTitle: "सेवा भारत पोर्टल",
				welcomeTitle: "नागरिक पोर्टलमध्ये आपले स्वागत आहे",
				typewriterText: "सरकारी कल्याणकारी योजनांसाठी एकच, एकत्रित व्यासपीठ.",
				eligibilityTitle: "त्वरित पात्रता तपासणी",
				yourName: "तुमचे नाव",
				namePlaceholder: "उदा. रमेश कुमार",
				state: "राज्य",
				statePlaceholder: "उदा. महाराष्ट्र",
				yourAge: "तुमचे वय",
				agePlaceholder: "उदा. 35",
				gender: "लिंग",
				genderSelect: "निवडा...",
				genderMale: "पुरुष",
				genderFemale: "महिला",
				genderOther: "इतर",
				income: "वार्षिक उत्पन्न (₹)",
				incomePlaceholder: "उदा. 250000",
				findSchemes: "माझ्या योजना शोधा",
				allSchemesTitle: "सर्व सरकारी योजना",
				resetFilter: "पात्रता फिल्टर साफ करा आणि सर्व दाखवा",
				mapTitle: "तुमच्या जवळील सरकारी सेवा केंद्र शोधा",
				findCenters: "माझ्या जवळचे केंद्र शोधा",
				profileTitle: "माझे डॅशबोर्ड",
				backToPortal: "पोर्टलवर परत जा",
				profileCardTitle: "नागरिकाचे नाव",
				profileJoined: "सामील: ",
				profileChartTitle: "तुमच्या जतन केलेल्या योजनांचे विभाजन",
				profileSavedSchemes: "माझ्या जतन केलेल्या योजना",
				saveSchemeTitle: "योजना जतन करा",
				knowMore: "अधिक माहिती",
				applyNow: "आता अर्ज करा",
				saveSchemePlaceholder: "तुम्ही अद्याप कोणतीही योजना जतन केलेली नाही. ती जतन करण्यासाठी योजनेवरील बुकमार्क चिन्हावर क्लिक करा.",
				saveChartPlaceholder: "तुमचा वैयक्तिक डॅशबोर्ड पाहण्यासाठी योजना जतन करा.",
				loginTitle: "सेवा सारथी",
				loginSubtitle: "सरकारी योजनांसाठी तुमचे मार्गदर्शक",
				loginUsername: "वापरकर्तानाव / आधार क्रमांक",
				loginPassword: "संकेतशब्द",
				loginBtn: "लॉगिन करा",
				registerBtn: "नोंदणी करा",
				registerModalTitle: "सेवा भारतासाठी नोंदणी करा",
				registerName: "पूर्ण नाव",
				registerEmail: "ईमेल पत्ता",
				registerConfirmPassword: "संकेतशब्द निश्चित करा",
				redirectTitle: "तुम्ही सेवा भारत सोडत आहात",
				redirectMessage: "तुमचा अर्ज पूर्ण करण्यासाठी तुम्हाला एका अधिकृत सरकारी वेबसाइटवर रीडायरेक्ट केले जाईल. कृपया तुमचे दस्तऐवज तयार ठेवा.",
				redirectStay: "इथेच थांबा",
				redirectProceed: "पुढे जा",
				aiAssistantTitle: "जेमिनी एआय योजना सहाय्यक",
				generateGuideBtn: "✨ सरलीकृत मार्गदर्शिका आणि चेकलिस्ट तयार करा",
			},
			te: { // Adding a fourth language as requested, using English placeholders where specific Telugu translations are complex.
				portalTitle: "సేవా భారత్ పోర్టల్",
				welcomeTitle: "పౌర పోర్టల్‌కు స్వాగతం",
				typewriterText: "ప్రభుత్వ సంక్షేమ పథకాల కోసం ఒకే, ఏకీకృత వేదిక.",
				eligibilityTitle: "త్వరిత అర్హత తనిఖీ",
				yourName: "మీ పేరు",
				namePlaceholder: "ఉదా. రమేష్ కుమార్",
				state: "రాష్ట్రం",
				statePlaceholder: "ఉదా. మహారాష్ట్ర",
				yourAge: "మీ వయస్సు",
				agePlaceholder: "ఉదా. 35",
				gender: "లింగం",
				genderSelect: "ఎంచుకోండి...",
				genderMale: "పురుషుడు",
				genderFemale: "స్త్రీ",
				genderOther: "ఇతర",
				income: "వార్షిక ఆదాయం (₹)",
				incomePlaceholder: "ఉదా. 250000",
				findSchemes: "నా పథకాలను కనుగొనండి",
				allSchemesTitle: "అన్ని ప్రభుత్వ పథకాలు",
				resetFilter: "అర్హత ఫిల్టర్‌ను క్లియర్ చేసి అన్నింటినీ చూపించు",
				mapTitle: "మీ దగ్గర ప్రభుత్వ సేవా కేంద్రాన్ని కనుగొనండి",
				findCenters: "నా దగ్గర కేంద్రాలను కనుగొనండి",
				profileTitle: "నా డాష్‌బోర్డ్",
				backToPortal: "పోర్టల్‌కు తిరిగి వెళ్లండి",
				profileCardTitle: "పౌరుడి పేరు",
				profileJoined: "చేరింది: ",
				profileChartTitle: "మీ సేవ్ చేయబడిన పథకాల విశ్లేషణ",
				profileSavedSchemes: "నా సేవ్ చేయబడిన పథకాలు",
				saveSchemeTitle: "పథకాన్ని సేవ్ చేయండి",
				knowMore: "మరింత తెలుసుకోండి",
				applyNow: "ఇప్పుడే దరఖాస్తు చేయండి",
				saveSchemePlaceholder: "మీరు ఇంకా పథకాలను సేవ్ చేయలేదు. సేవ్ చేయడానికి బుక్‌మార్క్ చిహ్నంపై క్లిక్ చేయండి.",
				saveChartPlaceholder: "మీ వ్యక్తిగత డాష్‌బోర్డ్‌ను చూడటానికి పథకాలను సేవ్ చేయండి.",
				loginTitle: "సేవా సారథి",
				loginSubtitle: "ప్రభుత్వ పథకాలకు మీ మార్గదర్శి",
				loginUsername: "వినియోగదారు పేరు / ఆధార్ సంఖ్య",
				loginPassword: "పాస్‌వర్డ్",
				loginBtn: "లాగిన్ చేయండి",
				registerBtn: "నమోదు చేయండి",
				registerModalTitle: "సేవా భారత్‌లో నమోదు చేయండి",
				registerName: "పూర్తి పేరు",
				registerEmail: "ఇమెయిల్ చిరునామా",
				registerConfirmPassword: "పాస్‌వర్డ్‌ను నిర్ధారించండి",
				redirectTitle: "మీరు సేవా భారత్ నుండి నిష్క్రమిస్తున్నారు",
				redirectMessage: "మీ దరఖాస్తును పూర్తి చేయడానికి మీరు అధికారిక ప్రభుత్వ వెబ్‌సైట్‌కు మళ్లించబడతారు. దయచేసి మీ పత్రాలను సిద్ధంగా ఉంచుకోండి.",
				redirectStay: "ఇక్కడే ఉండండి",
				redirectProceed: "కొనసాగించండి",
				aiAssistantTitle: "జెమిని AI పథకం సహాయకుడు",
				generateGuideBtn: "✨ సరళీకృత గైడ్ & చెక్‌లిస్ట్ సృష్టించండి",
			},
		};

		/**
		 * Applies the current language translations to all marked HTML elements.
		 * Updates innerText, title, and placeholder attributes.
		 */
		function applyTranslations() {
			const lang = currentLanguage;
			const t = translations[lang] || translations['en']; // Fallback to English

			// 1. Update text content
			document.querySelectorAll('[data-i18n]').forEach(el => {
				const key = el.dataset.i18n;
				if (t[key]) {
					el.textContent = t[key];
				}
			});

			// 2. Update placeholders
			document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
				const key = el.dataset.i18nPlaceholder;
				if (t[key]) {
					el.placeholder = t[key];
				}
			});

			// 3. Update titles (for bookmark button)
			document.querySelectorAll('[data-i18n-title]').forEach(el => {
				const key = el.dataset.i18nTitle;
				if (t[key]) {
					el.title = t[key];
				}
			});

			// 4. Update elements with prefixes (like 'Joined: [Date]')
			document.querySelectorAll('[data-i18n-prefix]').forEach(el => {
				const key = el.dataset.i18nPrefix;
				const originalContent = el.querySelector('#profile-join-date').textContent;
				if (t[key]) {
					el.innerHTML = `${t[key]} <span id="profile-join-date">${originalContent}</span>`;
				}
			});
			
			// 5. Update typewriter text without restarting animation
			// This is only called when the page is loaded, but ensuring the data is correct.
			if (window.typewriterTextFull) {
				window.typewriterTextFull = t.typewriterText;
			}
			
			// 6. Special case: If the AI button exists, update its text
			const aiBtn = document.getElementById('btn-ai-assist');
			if (aiBtn && !aiBtn.disabled) {
				aiBtn.textContent = t.generateGuideBtn;
			}
			
			// 7. Special case: Update profile card display text if not logged in.
			const profileUsernameDisplay = document.getElementById('profile-username-display');
			// isLoggedIn is now a global variable, accessible here.
			if (profileUsernameDisplay && !isLoggedIn) {
				profileUsernameDisplay.textContent = t.profileCardTitle;
			}
		}

		// --- GEMINI API UTILITY FUNCTIONS ---
		const apiKey = ""; 
		const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
		
		/**
		 * Handles fetching the Gemini API response with exponential backoff.
		 * @param {object} payload - The Gemini API request payload.
		 * @param {number} retries - Current retry count.
		 * @returns {Promise<object>} The parsed API response.
		 */
		async function fetchGeminiResponse(payload, retries = 0) {
			try {
				const response = await fetch(geminiApiUrl, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload)
				});

				if (response.status === 429 && retries < 3) {
					// Too Many Requests, implement exponential backoff
					const delay = Math.pow(2, retries) * 1000;
					await new Promise(resolve => setTimeout(resolve, delay));
					// console.log(`Retrying API call (${retries + 1})...`); // Commented out to adhere to silent retry rule
					return fetchGeminiResponse(payload, retries + 1);
				}

				if (!response.ok) {
					throw new Error(`API call failed with status: ${response.status}`);
				}

				return response.json();
			} catch (error) {
				console.error('Gemini API fetch error:', error);
				throw new Error('Failed to connect to the AI assistant.');
			}
		}

		/**
		 * Calls the Gemini API to generate a simplified guide and checklist for a scheme.
		 * @param {object} scheme - The scheme object containing name and details.
		 */
		async function generateAiGuide(scheme) {
			const resultContainer = document.getElementById('ai-result-container');
			const aiButton = document.getElementById('btn-ai-assist');
			const t = translations[currentLanguage] || translations['en'];

			// Set loading state
			aiButton.disabled = true;
			aiButton.innerHTML = `<span class="ai-loading-spinner me-2"></span> ${t.generateGuideBtn}...`;
			resultContainer.innerHTML = '';

			const schemeInfo = `Scheme Name: ${scheme.name}. 
Scheme Objective: ${scheme.details.objective}. 
Key Benefits: ${scheme.details.benefits}. 
Documents Mentioned: ${scheme.details.documents}.`;
			
			const systemPrompt = `You are the Seva Bharat AI Assistant, a helpful guide for Indian citizens. Your task is to process the provided scheme information.
				1. Write a section titled 'Simplified Scheme Summary' in Hindi or English (use Hindi if the scheme name is Hindi, otherwise English) to explain the scheme's core purpose in simple, accessible language (Grade 6 level).
				2. Write a second section titled 'Step-by-Step Application Guide & Checklist'. This section must use Google Search to find current application steps and a comprehensive checklist for the scheme. Provide concise steps and a bulleted list of all documents.
				3. Format the entire response using Markdown only, ensuring clear headings. DO NOT include any introductory or concluding sentences outside of the formatted markdown.`;
			
			const userQuery = `Generate the simplified guide and checklist for this scheme: ${schemeInfo}`;

			const payload = {
				contents: [{ parts: [{ text: userQuery }] }],
				tools: [{ "google_search": {} }],
				systemInstruction: {
					parts: [{ text: systemPrompt }]
				},
			};

			try {
				const result = await fetchGeminiResponse(payload);
				const candidate = result.candidates?.[0];

				let generatedText = "Could not generate guidance.";
				let sources = [];

				if (candidate && candidate.content?.parts?.[0]?.text) {
					generatedText = candidate.content.parts[0].text;
					
					// Extract sources from grounding metadata
					const groundingMetadata = candidate.groundingMetadata;
					if (groundingMetadata && groundingMetadata.groundingAttributions) {
						sources = groundingMetadata.groundingAttributions
							.map(attribution => ({
								uri: attribution.web?.uri,
								title: attribution.web?.title,
							}))
							.filter(source => source.uri && source.title);
					}
				}

				// Display AI result
				const htmlContent = `
					<div class="card card-body bg-light">
						${marked(generatedText)}
						${sources.length > 0 ? `
							<hr class="mt-3 mb-2">
							<small class="text-muted">Sources:</small>
							<ul class="list-unstyled small">
								${sources.map(source => `<li><a href="${source.uri}" target="_blank" rel="noopener noreferrer">${source.title}</a></li>`).join('')}
							</ul>
						` : ''}
					</div>
				`;
				resultContainer.innerHTML = htmlContent;

			} catch (error) {
				resultContainer.innerHTML = `<div class="alert alert-danger mt-3" role="alert">
					Error: ${error.message} Please try again.
				</div>`;
			} finally {
				// Reset button state
				aiButton.disabled = false;
				aiButton.innerHTML = t.generateGuideBtn;
			}
		}
		
		// Simple Markdown parser for displaying the result from LLM (copied from previous projects)
		const marked = (markdown) => {
			let html = markdown
				.replace(/^###### (.*$)/gim, '<h6>$1</h6>')
				.replace(/^##### (.*$)/gim, '<h5>$1</h5>')
				.replace(/^#### (.*$)/gim, '<h4>$1</h4>')
				.replace(/^### (.*$)/gim, '<h3>$1</h3>')
				.replace(/^## (.*$)/gim, '<h2>$1</h2>')
				.replace(/^# (.*$)/gim, '<h1>$1</h1>')
				.replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
				.replace(/\*(.*)\*/gim, '<em>$1</em>')
				// Convert lists (list items only)
				.replace(/^- (.*$)/gim, '<li>$1</li>');

			// Wrap list items in <ul> or <ol>
			let inList = false;
			const lines = html.split('\n');
			const processedLines = lines.map(line => {
				if (line.trim().startsWith('<li>')) {
					if (!inList) {
						inList = true;
						return '<ul>' + line;
					}
					return line;
				} else {
					if (inList) {
						inList = false;
						return '</ul>' + line;
					}
					return line;
				}
			});
			if (inList) processedLines.push('</ul>');

			// Basic paragraph wrapping for lines not already in tags
			html = processedLines.join('\n');
			html = html.split('\n').map(line => {
				const trimmedLine = line.trim();
				// Check if the line is empty or already starts with a common HTML tag
				if (trimmedLine === '' || trimmedLine.match(/<h|<ul|<p|<div|<hr|<li/i)) {
					return line;
				}
				// Check for simple line breaks that shouldn't be wrapped as paragraphs
				if (trimmedLine.endsWith('<br>') || trimmedLine.endsWith('<br/>')) {
					return line;
				}
				return `<p>${trimmedLine}</p>`;
			}).join('\n');

			return html.replace(/<p><\/p>/g, ''); // Remove empty paragraphs
		};


		const serviceCenters = [
			{
				name: 'Maha E-Seva Kendra',
				address: 'Kalyan Station Rd, Kalyan West',
				lat: 19.245,
				lon: 73.135,
			},
			{
				name: 'Aadhaar Seva Kendra',
				address: 'Near Shivaji Chowk, Kalyan',
				lat: 19.238,
				lon: 73.128,
			},
			{
				name: 'Citizen Facilitation Center',
				address: 'KDMC Office, Shankarrao Chowk',
				lat: 19.240,
				lon: 73.138,
			},
			{
				name: 'Digi-Connect Services',
				address: 'Adharwadi, Kalyan West',
				address: 'Adharwadi, Kalyan West',
				lat: 19.255,
				lon: 73.132,
			},
		];


		/**
		 * Calculates the great-circle distance between two points on the Earth's surface 
		 * using the Haversine formula.
		 * @param {number} lat1 Latitude of point 1
		 * @param {number} lon1 Longitude of point 1
		 * @param {number} lat2 Latitude of point 2
		 * @param {number} lon2 Longitude of point 2
		 * @returns {number} Distance in kilometers
		 */
		function haversineDistance(lat1, lon1, lat2, lon2) {
			const toRad = (x) => (x * Math.PI) / 180;
			const dLat = toRad(lat2 - lat1);
			const dLon = toRad(lon2 - lon1);
			lat1 = toRad(lat1);
			lat2 = toRad(lat2);

			const a =
				Math.sin(dLat / 2) * Math.sin(dLat / 2) +
				Math.cos(lat1) * Math.cos(lat2) *
				Math.sin(dLon / 2) * Math.sin(dLon / 2);
			const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
			return earthRadiusKm * c; // Distance in km
		}

		/**
		 * Renders the Leaflet map and initial markers.
		 * @param {number} lat Initial latitude
		 * @param {number} lon Initial longitude
		 * @param {number} zoom Initial zoom level
		 * @param {boolean} showDistance If true, shows initial distance (only for centers, not user marker)
		 */
		function renderMap(lat, lon, zoom = 13, showDistance = false) {
			const mapContainer = document.getElementById('map');
			// Destroy previous map instance if it exists
			if (mapInstance) {
				mapInstance.remove();
				mapInstance = null;
			}
			mapInstance = L.map('map').setView([lat, lon], zoom);
			L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
			}).addTo(mapInstance);

			// Add user marker
			L.marker([lat, lon])
				.addTo(mapInstance)
				.bindPopup('<b>Your current location</b>')
				.openPopup();

			// Add center markers
			serviceCenters.forEach((center) => {
				let popupText = `<b>${center.name}</b><br>${center.address}`;
				if (showDistance) {
					const distance = haversineDistance(lat, lon, center.lat, center.lon);
					popupText += `<br>Distance: ${distance.toFixed(2)} km`;
				}
				L.marker([center.lat, center.lon])
					.addTo(mapInstance)
					.bindPopup(popupText);
			});
		}

		/**
		 * Handles geolocation success/failure and initializes the map.
		 */
		function initializeMap() {
			const defaultCoords = [19.2423, 73.1313];
			const mapContainer = document.getElementById('map');
			const note = document.createElement('div');
			note.style.cssText = 'position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: #fff; padding: 5px 10px; border-radius: 5px; z-index: 1000; font-size: 12px;';

			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(
					(position) => {
						userLat = position.coords.latitude; // Update global user location
						userLon = position.coords.longitude;
						renderMap(userLat, userLon, 14); // Render map at user's location
					},
					() => {
						// Geolocation failed
						userLat = defaultCoords[0];
						userLon = defaultCoords[1];
						renderMap(userLat, userLon, 13);
						note.innerHTML = 'Could not get your location. Showing centers in Kalyan (Default).';
						mapContainer.appendChild(note);
					}
				);
			} else {
				// Browser doesn't support geolocation
				userLat = defaultCoords[0];
				userLon = defaultCoords[1];
				renderMap(userLat, userLon, 13);
				note.innerHTML = 'Geolocation not supported. Showing centers in Kalyan (Default).';
				mapContainer.appendChild(note);
			}
		}

		/**
		 * Calculates and displays distances to service centers, and updates the map popups.
		 */
		function findAndDisplayCenters() {
			const centerResultsDiv = document.getElementById('center-results');

			// If default location is still set, warn the user.
			if (userLat === 19.2423 && userLon === 73.1313) {
				centerResultsDiv.innerHTML = `<div class="alert alert-warning text-center">
					Location not precisely determined. Results based on Kalyan (Default Area).
					</div>`;
			} else {
				centerResultsDiv.innerHTML = `<div class="alert alert-info text-center">
					Showing closest centers to your current location (Latitude: ${userLat.toFixed(4)}, Longitude: ${userLon.toFixed(4)})
					</div>`;
			}


			let results = serviceCenters.map(center => {
				const distance = haversineDistance(userLat, userLon, center.lat, center.lon);
				return {
					...center,
					distance: distance
				};
			}).sort((a, b) => a.distance - b.distance); // Sort by distance

			let html = `<h5 class="mb-3">Closest Centers:</h5>`;
			html += `<ul class="list-group shadow-sm">`;
			results.forEach(center => {
				html += `
					<li class="list-group-item d-flex justify-content-between align-items-center">
						<div>
							<strong class="text-primary">${center.name}</strong>
							<div class="text-muted small">${center.address}</div>
						</div>
						<span class="badge bg-gradient-main rounded-pill">${center.distance.toFixed(2)} km</span>
					</li>
				`;
			});
			html += `</ul>`;
			centerResultsDiv.innerHTML += html;

			// Re-render map with distances in popups
			renderMap(userLat, userLon, 14, true);

			// Scroll to results
			centerResultsDiv.scrollIntoView({ behavior: 'smooth' });
		}
		
		let typewriterTextFull = translations['en'].typewriterText; // Global variable to hold current language text

		// New Typewriter Animation Function
		function typewriterEffect(elementId, text, speed) {
			const element = document.getElementById(elementId);
			if (!element) return;
			let i = 0;
			
			// Store the full text globally so translations can update it
			window.typewriterTextFull = text;

			// Make the element visible once the animation starts
			element.style.opacity = 1;
			element.textContent = ''; // Clear initial content

			function type() {
				// Use the potentially updated global text
				const currentText = window.typewriterTextFull;
				
				if (i < currentText.length) {
					element.textContent += currentText.charAt(i);
					i++;
					setTimeout(type, speed);
				} else {
					// Stop the cursor animation once text is fully typed
					element.style.borderRight = 'none';
				}
			}

			type();
		}


		document.addEventListener('DOMContentLoaded', () => {

			// --- Existing JavaScript code (your code) ---

			const categoryColors = {
				"Housing": "#5a67d8",
				"Health": "#d53f8c",
				"Agriculture": "#38a169",
				"Business": "#dd6b20",
				"Education": "#805ad5",
				"Social": "#3182ce"
			};

			schemesData = [ // Removed 'const' to use global variable
				// ADDED GENDER FIELD to all schemes. 'none' means universal.
				{ name: "Ladki Behn Yojan", category: "Social", gender: "female", minAge: 0, maxIncome: 800000, officialLink: "#", details: { objective: "A special initiative to support girls and women with scholarships, skill training and financial assistance.", benefits: "Scholarships, training programs and targeted financial aid.", documents: "Aadhaar Card, Birth Certificate, Guardian ID." } },
				{ name: "PM Awas Yojana (Urban)", category: "Housing", gender: "none", minAge: 18, maxIncome: 600000, officialLink: "https://pmay-urban.gov.in/", details: { objective: "To provide a pucca house to all eligible urban households.", benefits: "Subsidy on home loan interest rates.", documents: "Aadhaar Card, Proof of Income, Bank Account Details." } },
				{ name: "Ayushman Bharat PM-JAY", category: "Health", gender: "none", maxIncome: 500000, officialLink: "https://pmjay.gov.in/", details: { objective: "To provide health coverage to over 10 crore poor families.", benefits: "Cashless access to health care services.", documents: "Aadhaar Card, Ration Card." } },
				{ name: "PM Kisan Samman Nidhi", category: "Agriculture", gender: "none", minAge: 18, officialLink: "https://pmkisan.gov.in/", details: { objective: "To supplement the financial needs of Small and Marginal Farmers.", benefits: "Direct income support of ₹6,000 per year.", documents: "Aadhaar Card, Landholding papers." } },
				{ name: "Mudra Yojana", category: "Business", gender: "none", minAge: 18, officialLink: "https://www.mudra.org.in/", details: { objective: "To provide funding to the non-corporate, non-farm small/micro enterprises.", benefits: "Loans under Shishu, Kishor, and Tarun categories.", documents: "Business plan, KYC Documents." } },
				{ name: "Sarva Shiksha Abhiyan", category: "Education", gender: "none", officialLink: "#", details: { objective: "To provide for a variety of interventions for universal access and retention.", benefits: "Free and compulsory education to children.", documents: "Birth Certificate." } },
				{ name: "National Social Assistance", category: "Social", gender: "none", minAge: 60, officialLink: "#", details: { objective: "To provide a basic level of financial support to the elderly, widows and persons with disabilities.", benefits: "Monthly pension.", documents: "Aadhaar Card, BPL Card." } },
			];

			// Generate more schemes for demo
			for (let i = 0; i < 45; i++) {
				const category = ["Housing", "Health", "Agriculture", "Business", "Education", "Social"][i % 6];
				let minAge, maxIncome;
				let gender = "none";
				if (i % 7 === 1) gender = "female"; // Make some schemes female-specific
				if (i % 7 === 3) gender = "male";   // Make some schemes male-specific

				switch (category) {
					case "Housing": minAge = 21; maxIncome = 500000 + (i * 10000); break;
					case "Health": maxIncome = 300000 + (i * 5000); break;
					case "Agriculture": minAge = 18; break;
					case "Business": minAge = 18; maxIncome = 1000000; break;
					case "Education": maxIncome = 800000; break;
					case "Social": minAge = 58; break;
				}
				schemesData.push({ name: `Additional ${category} Scheme #${i + 1}`, category: category, gender: gender, minAge: minAge, maxIncome: maxIncome, officialLink: "#", details: { objective: "Placeholder objective", benefits: "Placeholder benefits", documents: "Placeholder documents" } });
			}

			const schemesGrid = document.getElementById('schemes-grid');
			const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
			const schemeDetailModal = new bootstrap.Modal(document.getElementById('schemeDetailModal'));
			const redirectModal = new bootstrap.Modal(document.getElementById('redirectModal'));
			const confirmRedirectBtn = document.getElementById('confirm-redirect-btn');
			const loginForm = document.getElementById('loginForm');
			const togglePassword = document.getElementById('togglePassword');
			const schemesListTitle = document.getElementById('schemes-list-title');
			const resetFilterBtn = document.getElementById('reset-filter-btn');
			const checkEligibilityBtn = document.getElementById('check-eligibility-btn');
			const navUserSection = document.getElementById('nav-user-section');
			const mainContent = document.getElementById('main-content');
			const profileSection = document.getElementById('profile-section');
			const savedSchemesGrid = document.getElementById('saved-schemes-grid');
			const chartPlaceholder = document.getElementById('chart-placeholder');
			const languageSelector = document.getElementById('language-selector');

			// Re-initialize arrays/variables that rely on schemesData, using the global scope variables
			currentFilteredSchemes = [...schemesData];
			// isLoggedIn, loggedInUsername, pendingApplyUrl, allSchemesVisible, savedSchemes, savedSchemesChartInstance
			// are already declared and initialized globally at the top of the script.


			// Utility: show inline feedback messages inside a modal or container
			function showFeedback(containerId, message, type = 'danger', autoHideMs = 6000) {
				const container = document.getElementById(containerId);
				if (!container) return;
				// Clear previous
				container.innerHTML = '';

				const wrapper = document.createElement('div');
				wrapper.className = `alert alert-${type} alert-dismissible fade show`;
				wrapper.setAttribute('role', 'alert');
				wrapper.innerHTML = `
		 			<div>${message}</div>
		 			<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
		 		`;
				container.appendChild(wrapper);

				if (autoHideMs > 0) {
					setTimeout(() => {
						try { wrapper.classList.remove('show'); wrapper.classList.add('hide'); } catch (e) { }
						if (wrapper.parentNode) wrapper.parentNode.removeChild(wrapper);
					}, autoHideMs);
				}
			}

			// Functions for rendering schemes
			function createSchemeCardHTML(scheme, index) {
				const t = translations[currentLanguage] || translations['en'];
				
				const icons = {
					Housing: 'fa-house-chimney',
					Health: 'fa-heart-pulse',
					Agriculture: 'fa-tractor',
					Business: 'fa-briefcase',
					Education: 'fa-graduation-cap',
					Social: 'fa-users'
				};
				const iconClass = icons[scheme.category] || 'fa-file-alt';
				const isSaved = savedSchemes.includes(index);
				const saveIconClass = isSaved ? 'fa-solid fa-bookmark saved' : 'fa-regular fa-bookmark';

				return `
		 	<div class="scheme-card" data-category="${scheme.category}">
		 	  <i class="btn-save-scheme ${saveIconClass}" data-scheme-index="${index}" title="${t.saveSchemeTitle}"></i>
		 	  <div class="scheme-card-header">
		 	    <div class="scheme-card-icon-wrapper"><i class="fa-solid ${iconClass}"></i></div>
		 	    <h5 class="card-title">${scheme.name}</h5>
		 	  </div>
		 	  <div class="card-body">
		 	    <p class="card-text">${scheme.details.objective || 'Details about this scheme.'}</p>
		 	    <div class="card-buttons">
		 	      <button class="btn btn-learn-more" data-scheme-index="${index}">${t.knowMore}</button>
		 	      <button class="btn btn-apply-now" data-link="${scheme.officialLink}">${t.applyNow}</button>
		 	    </div>
		 	  </div>
		 	</div>`;
			}

			function renderSchemes(schemes, gridElement) {
				const t = translations[currentLanguage] || translations['en'];
				gridElement.innerHTML = '';
				if (schemes.length === 0) {
					gridElement.innerHTML = `<p class="text-muted text-center col-12">${t.saveSchemePlaceholder}</p>`;
					return;
				}

				const schemesToDisplay = allSchemesVisible ? schemes : schemes.slice(0, 6);

				schemesToDisplay.forEach((scheme) => {
					const card = document.createElement('div');
					card.className = 'col-md-6 col-lg-4';
					const originalIndex = schemesData.indexOf(scheme);
					card.innerHTML = createSchemeCardHTML(scheme, originalIndex);
					gridElement.appendChild(card);
				});

				if (gridElement.id === 'schemes-grid' && schemes.length > 6) {
					const buttonContainer = document.createElement('div');
					buttonContainer.className = 'col-12 text-center mt-4';
					if (allSchemesVisible) {
						buttonContainer.innerHTML = `<button id="show-less-btn" class="btn btn-outline-secondary">Show Less Schemes</button>`;
					} else {
						buttonContainer.innerHTML = `<button id="show-more-btn" class="btn btn-outline-primary">Show More Schemes</button>`;
					}
					gridElement.appendChild(buttonContainer);
				}
			}

			// Saved schemes rendering
			function createSavedSchemeCardHTML(scheme, index) {
				const t = translations[currentLanguage] || translations['en'];
				const icons = {
					Housing: 'fa-house-chimney',
					Health: 'fa-heart-pulse',
					Agriculture: 'fa-tractor',
					Business: 'fa-briefcase',
					Education: 'fa-graduation-cap',
					Social: 'fa-users'
				};
				const iconClass = icons[scheme.category] || 'fa-file-alt';
				const categoryKey = scheme.category.toLowerCase();

				return `
		 	<div class="saved-scheme-card">
		 	  <div class="scheme-card-icon-wrapper" style="background-color: var(--cat-${categoryKey});">
		 	    <i class="fa-solid ${iconClass}"></i>
		 	  </div>
		 	  <div class="saved-scheme-card-body">
		 	    <h6 class="card-title">${scheme.name}</h6>
		 	    <p class="card-text small text-muted mb-0">${scheme.category}</p>
		 	    <p class="card-text small text-muted mb-0">${scheme.details.objective}</p>
		 	  </div>
		 	  <div class="saved-scheme-card-actions">
		 	    <button class="btn btn-sm btn-learn-more" data-scheme-index="${index}">${t.knowMore}</button>
		 	    <button class="btn btn-sm btn-apply-now" data-link="${scheme.officialLink}">${t.applyNow}</button>
		 	    <button class="btn btn-sm btn-outline-danger btn-remove-scheme" data-scheme-index="${index}" title="Remove Scheme"><i class="fa-solid fa-trash-alt"></i></button>
		 	  </div>
		 	</div>`;
			}

			function renderSavedSchemes() {
				const t = translations[currentLanguage] || translations['en'];
				savedSchemesGrid.innerHTML = '';
				const savedSchemesData = savedSchemes.map((index) => schemesData[index]);
				if (savedSchemesData.length === 0) {
					savedSchemesGrid.innerHTML = `<p class="text-muted text-center col-12">${t.saveSchemePlaceholder}</p>`;
				} else {
					savedSchemesData.forEach((scheme) => {
						const originalIndex = schemesData.indexOf(scheme);
						savedSchemesGrid.innerHTML += createSavedSchemeCardHTML(scheme, originalIndex);
					});
				}
				renderSavedSchemesChart();
			}

			function renderSavedSchemesChart() {
				if (savedSchemesChartInstance) {
					savedSchemesChartInstance.destroy();
				}

				const savedSchemesData = savedSchemes.map((index) => schemesData[index]);

				if (savedSchemesData.length === 0) {
					chartPlaceholder.style.display = 'block';
					return;
				} else {
					chartPlaceholder.style.display = 'none';
				}

				const categoryCounts = savedSchemesData.reduce((acc, scheme) => {
					acc[scheme.category] = (acc[scheme.category] || 0) + 1;
					return acc;
				}, {});

				const labels = Object.keys(categoryCounts);
				const data = Object.values(categoryCounts);
				const backgroundColors = labels.map((label) => categoryColors[label] || '#cccccc');

				const ctx = document.getElementById('savedSchemesChart').getContext('2d');
				savedSchemesChartInstance = new Chart(ctx, {
					type: 'doughnut',
					data: {
						labels: labels,
						datasets: [
							{
								label: 'Saved Schemes',
								data: data,
								backgroundColor: backgroundColors,
								borderColor: 'var(--color-secondary)',
								borderWidth: 4,
							},
						],
					},
					options: {
						responsive: true,
						plugins: {
							legend: {
								position: 'bottom',
							},
							tooltip: {
								callbacks: {
									label: function (context) {
										let label = context.label || '';
										if (label) {
											label += ': ';
										}
										if (context.parsed !== null) {
											label += context.parsed + ' scheme(s)';
										}
										return label;
									},
								},
							},
						},
					},
				});
			}

			// Show profile view
			function showProfileView() {
				mainContent.classList.add('d-none');
				profileSection.classList.remove('d-none');
				document.getElementById('profile-username-display').textContent = document.getElementById('name').value || translations[currentLanguage].profileCardTitle;
				document.getElementById('profile-state-display').textContent = document.getElementById('state').value || 'Not Specified';
				document.getElementById('profile-join-date').textContent = new Date().toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' });
				// Set the profile link as active
				const profileLink = document.querySelector('#dashboard-links .nav-link[data-view="profile"]');
				if (profileLink) {
					profileLink.classList.add('active');
				}
				
				renderSavedSchemes();
				window.scrollTo(0, 0);
			}

			// Show main view
			function showMainView() {
				mainContent.classList.remove('d-none');
				profileSection.classList.add('d-none');
				const activeLink = document.querySelector('#dashboard-links .nav-link.active');
				if (activeLink) activeLink.classList.remove('active');
			}

			// Update navigation buttons
			function updateNavButtons() {
				const t = translations[currentLanguage] || translations['en'];
				navUserSection.innerHTML = '';

				if (isLoggedIn) {
					navUserSection.innerHTML = `
		 	    <div id="dashboard-links" class="d-flex align-items-center">
		 	      <a class="nav-link mx-1" data-view="profile" style="cursor:pointer;"><i class="fa-solid fa-user-circle me-1"></i>${t.profileTitle}</a>
		 	    </div>
		 	    <div class="ms-3 vr"></div>
		 	    <span class="logged-in-status ms-3"><i class="fa-solid fa-circle-check me-2"></i>Logged In</span>
		 	    <button id="logout-btn-nav" class="btn btn-logout ms-2" title="Logout"><i class="fa-solid fa-right-from-bracket"></i></button>
		 	`;
					document
						.getElementById('logout-btn-nav')
						.addEventListener('click', () => {
							isLoggedIn = false;
							savedSchemes = [];
							if (savedSchemesChartInstance) {
								savedSchemesChartInstance.destroy();
								savedSchemesChartInstance = null;
							}
							showMainView();
							updateNavButtons();
							renderSchemes(currentFilteredSchemes, schemesGrid);
						});
					document
						.querySelector('#dashboard-links .nav-link[data-view="profile"]')
						.addEventListener('click', showProfileView);
				} else {
					// The header buttons already use the main gradient (btn-gradient-main)
					navUserSection.innerHTML = `
		 	    <button id="login-btn-nav" class="btn btn-sm btn-gradient-main d-flex align-items-center me-2"><i class="fa-solid fa-right-to-bracket me-2"></i>${t.loginBtn}</button>
		 	    <button id="register-btn" class="btn btn-sm btn-gradient-main d-flex align-items-center"><i class="fa-solid fa-user-plus me-2"></i>${t.registerBtn}</button>
		 	`;
					document
						.getElementById('login-btn-nav')
						.addEventListener('click', () => loginModal.show());
					document
						.getElementById('register-btn')
						.addEventListener('click', () => {
							// Show registration modal
							registerModal.show();
						});
				}
			}
			
			// --- LANGUAGE CHANGE HANDLER ---
			languageSelector.addEventListener('change', (e) => {
				currentLanguage = e.target.value;
				applyTranslations();
				updateNavButtons(); // Re-render dynamic nav buttons with new language
				renderSchemes(currentFilteredSchemes, schemesGrid); // Re-render cards with new language
				if (!profileSection.classList.contains('d-none')) {
					renderSavedSchemes(); // Re-render saved cards with new language
				}
				
				// Re-initiate typewriter with new language text
				typewriterEffect('typewriter-output', translations[currentLanguage].typewriterText, 50);
			});
			// --- END LANGUAGE CHANGE HANDLER ---


			// Confirm and redirect
			function confirmAndRedirect(url) {
				pendingApplyUrl = url;
				redirectModal.show();
			}

			// Event delegation for clicks
			document.body.addEventListener('click', (e) => {
				const target = e.target;

				const applyBtn = target.closest('.btn-apply-now');
				if (applyBtn) {
					const url = applyBtn.dataset.link;
					if (isLoggedIn) {
						confirmAndRedirect(url);
					} else {
						pendingApplyUrl = url;
						loginModal.show();
					}
				}

				const learnMoreBtn = target.closest('.btn-learn-more');
				if (learnMoreBtn) {
					const schemeIndex = learnMoreBtn.dataset.schemeIndex;
					const scheme = schemesData[schemeIndex];
					const t = translations[currentLanguage] || translations['en'];
					if (scheme && scheme.details) {
						document.getElementById('schemeDetailModalLabel').textContent = scheme.name;
						
						// --- UPDATED MODAL CONTENT WITH AI BUTTON ---
						document.getElementById('scheme-modal-body').innerHTML = `
							<h6>Objective</h6><p>${scheme.details.objective}</p>
							<h6>Benefits</h6><p>${scheme.details.benefits}</p>
							<h6>Documents Required</h6><p>${scheme.details.documents}</p>
							
							<hr class="my-4">
							<div class="card p-3 bg-light">
								<h6 class="mb-3 text-primary"><i class="fa-solid fa-bolt-lightning me-2 text-warning"></i>${t.aiAssistantTitle}</h6>
								<button id="btn-ai-assist" data-scheme-index="${schemeIndex}" class="btn btn-gradient-main btn-sm">
									${t.generateGuideBtn}
								</button>
								<div id="ai-result-container" class="mt-3"></div>
							</div>
						`;
						// --- END UPDATED MODAL CONTENT ---
						
						schemeDetailModal.show();
					}
				}
				
				// New Event Listener for the AI Button (delegated, checking target ID)
				const aiAssistBtn = target.closest('#btn-ai-assist');
				if (aiAssistBtn) {
					const schemeIndex = aiAssistBtn.dataset.schemeIndex;
					const scheme = schemesData[schemeIndex];
					if (scheme) {
						generateAiGuide(scheme);
					}
				}


				if (target.id === 'show-more-btn') {
					allSchemesVisible = true;
					renderSchemes(currentFilteredSchemes, schemesGrid);
				}
				if (target.id === 'show-less-btn') {
					allSchemesVisible = false;
					renderSchemes(currentFilteredSchemes, schemesGrid);
					document.getElementById('all-schemes').scrollIntoView({ behavior: 'smooth' });
				}

				const saveBtn = target.closest('.btn-save-scheme');
				if (saveBtn) {
					if (!isLoggedIn) {
						loginModal.show();
						return;
					}
					const schemeIndex = parseInt(saveBtn.dataset.schemeIndex);
					const indexInSaved = savedSchemes.indexOf(schemeIndex);
					if (indexInSaved > -1) {
						savedSchemes.splice(indexInSaved, 1);
					} else {
						savedSchemes.push(schemeIndex);
					}

					renderSchemes(currentFilteredSchemes, schemesGrid);
					if (!profileSection.classList.contains('d-none')) {
						renderSavedSchemes();
					}
				}

				const removeBtn = target.closest('.btn-remove-scheme');
				if (removeBtn) {
					const schemeIndex = parseInt(removeBtn.dataset.schemeIndex);
					const indexInSaved = savedSchemes.indexOf(schemeIndex);
					if (indexInSaved > -1) {
						savedSchemes.splice(indexInSaved, 1);
					}
					renderSavedSchemes();
					renderSchemes(currentFilteredSchemes, schemesGrid);
				}
			});

			togglePassword.addEventListener('click', function () {
				const passwordInput = document.getElementById('login-password');
				const type =
					passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
				passwordInput.setAttribute('type', type);
				this.classList.toggle('fa-eye');
				this.classList.toggle('fa-eye-slash');
			});

			// Login form submit - authenticate against mock backend
			document.getElementById('loginForm').addEventListener('submit', async (e) => {
				e.preventDefault();

				const username = document.getElementById('login-username').value.trim();
				const password = document.getElementById('login-password').value;

				if (!username || !password) {
					showFeedback('login-feedback', 'Please enter both username and password.', 'warning');
					return;
				}

				// --- MOCK AUTHENTICATION START ---
				// In a real application, this would call a server-side endpoint.
				// Since this is a client-side demo, we mock a successful login.
				if (username && password.length >= 6) {
					// Simulate success
					isLoggedIn = true;
					loggedInUsername = username;
					loginModal.hide();
					updateNavButtons();
					renderSchemes(currentFilteredSchemes, schemesGrid);

					if (pendingApplyUrl) {
						confirmAndRedirect(pendingApplyUrl);
					}
					// Clear credentials for security, even in a mock
					document.getElementById('login-password').value = '';
					
				} else {
					// Simulate failure
					showFeedback('login-feedback', 'Invalid credentials or user not registered.', 'danger');
				}
				// --- MOCK AUTHENTICATION END ---
			});

			document
				.getElementById('confirm-redirect-btn')
				.addEventListener('click', () => {
					if (pendingApplyUrl) {
						// Note: window.open might be blocked if not triggered by user action in some environments.
						window.open(pendingApplyUrl, '_blank');
						pendingApplyUrl = null;
					}
					redirectModal.hide();
				});

			// --- Registration logic ---
			// Create registration modal instance
			const registerModal = new bootstrap.Modal(
				document.getElementById('registerModal')
			);

			// Registration form submit - mock registration
			document.getElementById('registerForm').addEventListener('submit', async (e) => {
				e.preventDefault();

				const name = document.getElementById('register-name').value.trim();
				const email = document.getElementById('register-email').value.trim();
				const username = document.getElementById('register-username').value.trim();
				const password = document.getElementById('register-password').value;
				const confirmPassword = document.getElementById('register-confirm-password').value;

				if (!password || password.length < 6) {
					showFeedback('register-feedback', 'Please enter a password with at least 6 characters.', 'warning');
					return;
				}

				if (password !== confirmPassword) {
					showFeedback('register-feedback', 'Passwords do not match.', 'warning');
					return;
				}

				if (!username) {
					showFeedback('register-feedback', 'Please provide a unique username.', 'warning');
					return;
				}

				// --- MOCK REGISTRATION START ---
				// Simulate success
				isLoggedIn = true;
				loggedInUsername = username;
				registerModal.hide();
				updateNavButtons();
				showProfileView();
				// --- MOCK REGISTRATION END ---
			});

			// Eligibility check logic (UPDATED)
			document
				.getElementById('check-eligibility-btn')
				.addEventListener('click', () => {
					// Get inputs
					const ageInput = document.getElementById('age');
					const incomeInput = document.getElementById('income');
					const genderInput = document.getElementById('gender');

					// Basic validation
					if (!ageInput.value || !incomeInput.value || !genderInput.value) {
						showFeedback('eligibility-checker-feedback', 'Please fill in all eligibility fields (Age, Income, and Gender).', 'warning', 10000);
						return;
					}

					const age = parseInt(ageInput.value) || 0;
					const income = parseInt(incomeInput.value) || Infinity;
					const userGender = genderInput.value;

					currentFilteredSchemes = schemesData.filter((scheme) => {
						// 1. Age Check
						const ageMatch = !scheme.minAge || age >= scheme.minAge;

						// 2. Income Check
						const incomeMatch = !scheme.maxIncome || income <= scheme.maxIncome;

						// 3. Gender Check
						let genderMatch = true;
						const schemeGender = scheme.gender;

						if (schemeGender && schemeGender !== 'none') {
							// If scheme specifies a gender (male or female), user's gender must match it exactly
							if (userGender !== schemeGender) {
								genderMatch = false;
							}
						}
						// If schemeGender is 'none', it's universal, so genderMatch remains true.
						// If userGender is 'other', they won't match gender-specific schemes (which is correct).


						return ageMatch && incomeMatch && genderMatch;
					});
					
					// Display feedback message for the filter outside the grid
					const feedbackContainer = document.getElementById('eligibility-checker-feedback');
					if (feedbackContainer) feedbackContainer.remove(); // Remove previous feedback

					const resultCount = currentFilteredSchemes.length;
					const userGenderDisplay = userGender.charAt(0).toUpperCase() + userGender.slice(1);
					
					let message, type;
					
					// NOTE: Hardcoding feedback messages since they are generated at runtime and cannot use data-i18n easily.
					if (resultCount > 0) {
						message = `Found ${resultCount} scheme(s) matching your criteria (Age: ${age}, Income: ₹${income.toLocaleString('en-IN')}, Gender: ${userGenderDisplay}).`;
						type = 'success';
					} else {
						message = `No schemes matched all your eligibility criteria. Showing all schemes instead.`;
						type = 'danger';
					}

					
					const newFeedback = document.createElement('div');
					newFeedback.id = 'eligibility-checker-feedback';
					newFeedback.className = `mt-4`;
					document.getElementById('eligibility-checker').insertBefore(newFeedback, document.querySelector('#eligibility-checker .text-center'));
					showFeedback('eligibility-checker-feedback', message, type, 10000);


					allSchemesVisible = false;
					schemesListTitle.textContent = resultCount > 0 ? 'Eligible Schemes For You' : translations[currentLanguage].allSchemesTitle;
					resetFilterBtn.classList.remove('d-none');
					
					// Render filtered schemes, or all schemes if filter returned none
					const schemesToRender = resultCount > 0 ? currentFilteredSchemes : schemesData;
					if (resultCount === 0) {
						// If filter fails, reset internal filter state to show all for the grid
						currentFilteredSchemes = schemesData;
					}

					renderSchemes(schemesToRender, schemesGrid);
				});

			// Add a feedback container element just above the eligibility check button (if it doesn't exist)
			const checkBtnContainer = document.querySelector('#eligibility-checker .text-center');
			const existingFeedback = document.getElementById('eligibility-checker-feedback');
			if (!existingFeedback) {
				const feedbackDiv = document.createElement('div');
				feedbackDiv.id = 'eligibility-checker-feedback';
				feedbackDiv.className = 'mt-3';
				checkBtnContainer.parentNode.insertBefore(feedbackDiv, checkBtnContainer);
			}


			// Reset filter
			document
				.getElementById('reset-filter-btn')
				.addEventListener('click', () => {
					currentFilteredSchemes = [...schemesData];
					allSchemesVisible = false;
					schemesListTitle.textContent = translations[currentLanguage].allSchemesTitle;
					resetFilterBtn.classList.add('d-none');
					// Remove eligibility feedback message
					const feedbackContainer = document.getElementById('eligibility-checker-feedback');
					if (feedbackContainer) feedbackContainer.innerHTML = '';
					
					renderSchemes(currentFilteredSchemes, schemesGrid);
				});

			document
				.getElementById('back-to-schemes-btn')
				.addEventListener('click', showMainView);
			document
				.getElementById('home-link')
				.addEventListener('click', showMainView);

			// New: Find Centers button event listener
			document.getElementById('find-centers-btn')
				.addEventListener('click', findAndDisplayCenters);

			// Initial language load
			applyTranslations();

			// Initial render
			renderSchemes(currentFilteredSchemes, schemesGrid);
			updateNavButtons();
			initializeMap();

			// Start Typewriter Animation on load
			typewriterEffect('typewriter-output', translations[currentLanguage].typewriterText, 50);

		});
	</script>
</body>

</html>
